<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Twitter STX Tipping Bot</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://unpkg.com/@stacks/connect@latest"></script>
</head>
<body>
  <header>
    <h1>STX Tips</h1>
    <p>Send and receive STX tips via Twitter replies!</p>
  </header>

  <section>
    <h2>Sign In</h2>
    <p>Connect your Stacks wallet to get started with tipping.</p>
    <input type="text" id="twitter-handle" placeholder="Enter your Twitter handle">
    <button id="connect-wallet">Sign in with Xverse/Leather</button>
  </section>

  <section>
    <h2>Features</h2>
    <ul>
      <li>Wallet onboarding system for users to create and link their Stacks wallets</li>
      <li>Streamlined tipping process that automatically identifies the user's wallet</li>
      <li>Automatic tweet responses confirming successful transactions</li>
      <li>Error handling for invalid commands or failed transactions</li>
      <li>Integration with Supabase for transaction history storage</li>
    </ul>
  </section>

  <section>
    <h2>How It Works</h2>
    <p>To send a tip, simply reply to a tweet with the bot mentioned and include the amount of STX you want to send. For example, "10 STX". The bot will handle the rest and send a confirmation tweet.</p>
  </section>

  <section>
    <h2>Get Started</h2>
    <p>Follow the instructions in the <a href="README.md">README</a> to deploy your own Twitter STX Tipping Bot.</p>
  </section>

  <footer>
    <p>Created by NoCodeClarity</p>
    <p>Licensed under the MIT License</p>
  </footer>

  <script>
    const connectWalletButton = document.getElementById('connect-wallet');

    connectWalletButton.addEventListener('click', () => {
      const twitterHandle = document.getElementById('twitter-handle').value;
      if (!twitterHandle) {
        alert('Please enter your Twitter handle.');
        return;
      }

      const verificationCode = generateVerificationCode();

      const appConfig = new StacksConnect({
        appDetails: {
          name: 'STX Tips (Powered By NoCodeClarity)',
          icon: 'https://github.com/CMPGFB/twitterbot/blob/157dbe0c205e0fc806148bf1356849a1c41b4b0e/NCC%20Logo.png',  
        },
        redirectTo: '/',
        userSession: new UserSession({ appConfig: new AppConfig(['store_write', 'publish_data']) }),
      });

      appConfig.authenticate({
        onFinish: (authResponse) => {
          const userSession = new UserSession();
          const userData = userSession.loadUserData();
          const walletAddress = userData.profile.stxAddress.testnet; // Use .mainnet for mainnet
          alert(`Wallet connected: ${walletAddress}`);

          // Send wallet address, Twitter handle, and verification code to your backend
          fetch('/api/save-wallet', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ walletAddress, twitterHandle, verificationCode })
          }).then(response => {
            if (response.ok) {
              alert(`Please tweet the following code from your Twitter account to verify your wallet: ${verificationCode}`);
            } else {
              console.error('Failed to save wallet address.');
              alert('Failed to link wallet. Please try again.');
            }
          });
        },
      });
    });

    function generateVerificationCode() {
      return Math.random().toString(36).substr(2, 8);
    }
  </script>
</body>
</html>
